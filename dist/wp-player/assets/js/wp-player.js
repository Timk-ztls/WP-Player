/*!
 * @name     wp-player
 * @desc     初始化播放器。
 * @depend   jQuery, SoundManager2
 * @author   M.J
 * @date     2014-12-21
 * @update   2022-1-5
 * @URL      http://webjyh.com
 * @Github   https://github.com/webjyh/WP-Player
 * @reutn    {jQuery}
 * @version  2.6.2
 * 
 */
!function(f,e){function r(t,i){e.setup({url:i.swf,debugMode:!1}),this.index=0,this.url=i.url,this.nonce=i.nonce,this.img=i.img,this.IE6=!-[1]&&!window.XMLHttpRequest,this.single=i.single,this.lyric=null,this.offset={},this.mark=null,this.lyricH=300,this.line=27,this.isLoad=!1,this.$elem=f(t),this.first=!0,this.isMobile="createTouch"in document&&!("onmousemove"in document)||/(iPhone|iPad|iPod)/i.test(navigator.userAgent),this.getDOM(this.$elem).getAttr().init()}r.prototype={init:function(){var t=this.attr,i=this.DOM;i.time.text("00:00"),i.title.text("Loading..."),i.author.text("Loading..."),t.lyric&&this.isMobile&&i.lyricsbtn.hide(),this[t.id?"actions":"localAction"]()},actions:function(){var i=this;f.ajax({url:this.url,type:"post",headers:{nonce:this.nonce},data:{action:"wpplayer",type:this.attr.type,id:this.attr.id,source:this.attr.source}}).done(function(t){t.status&&t.data.list&&t.data.list.length&&(i.data=t.data.list,i.createList().getSongInfo().addEvent())}).fail(function(){window.console&&window.console.info("获取歌曲列表失败")})},getSongInfo:function(t,i){var s=void 0===t?0:t,e=this,t=this.DOM;if(t.time.text("00:00"),t.title.text("Loading..."),t.author.text("Loading..."),1!=this.attr.random||i||(s=this.random()),i=this.data[s],this.index=s,this.setList(),i&&!i.url&&!this.isLoad)return this.isLoad=!0,f.ajax({url:this.url,type:"post",headers:{nonce:this.nonce},data:{action:"wpplayerGetInfo",id:i.id,pic_id:i.pic_id,url_id:i.url_id,lyric_id:i.lyric_id,source:this.attr.source}}).done(function(t){e.isLoad=!1,t.status&&t.data&&(e.data[s].lyric=t.data.lyric.lyric,e.data[s].pic=t.data.pic.url,e.data[s].url=t.data.url.url,e.createSound(s))}).fail(function(){e.isLoad=!1,window.console&&window.console.info("获取歌曲失败")}),this},localAction:function(){if(void 0===this.attr.address)return!1;function t(t){var i=t.length-1;return t.substr(0,i).split("|")}var i=[],s=0,e=t(this.attr.title),a=t(this.attr.author),n=t(this.attr.address),r=t(this.attr.thumb);f.each(e,function(t){i.push({name:e[t],lyric:"",artist:[a[t]],url:n[t],pic:r[t]})}),this.data=i,this.createList(),1==this.attr.random&&(s=this.random()),this.index=s,this.setList(),this.createSound(this.index).addEvent()},createList:function(){for(var t=0,i="",s=this.DOM,e=this.data,a=e.length;t<a;t++){var n=t%2?"odd":"";i+=r.template.replace("{i}",t).replace("{class}",n).replace("{author}",e[t].artist.join("/")).replace("{serial}",t+1).replace("{title}",e[t].name)}return f(i).appendTo(s.list.children("ul")).eq(this.index).addClass("current"),s.list.height(s.list.outerHeight()),this},createSound:function(t){var a=this,i=this.data[void 0===t?0:t],n=this.DOM,s="true"==this.single&&"1"==this.attr.autoplay&&!this.isMobile;if(n.title.text(i.name),n.author.text(i.artist.join("/")),n.thumb.find("img").attr("src",i.pic),!(1<this.data.length)||i.url)return e.onready(function(){"object"==typeof a.sound&&a.sound.destruct(),a.timeReady=!!a.isMobile,a.sound=e.createSound({url:i.url,onload:function(){a.timeReady=!0},onplay:function(){a.setPlay()},onresume:function(){a.setPlay()},onpause:function(){a.setStop()},onfinish:function(){a.nextSound()},whileplaying:function(){var t,i,s=this.position/this.duration*100,s=100<s?"100%":s.toFixed(5)+"%",e=a.timeReady?(i="-",e=Math.floor((this.duration-this.position)/1e3),t=a.formatNumber(Math.floor(e/60)),a.formatNumber(Math.floor(e%60))):(i="",t="00");n.playbar.width(s),n.time.text(i+t+":"+e),a.attr.lyric&&a.lyric&&!a.isMobile&&a.setLyric(this.position)},whileloading:function(){var t=this.bytesTotal&&this.bytesLoaded!=this.bytesTotal?this.bytesLoaded/this.bytesTotal*100:100;n.seekbar.width(t+"%")},onerror:function(t,i){window.console&&console.log(this.id+" failed?",t,i),1<a.data.length&&a.nextSound()}}),a.soundEvent(),a.attr.lyric&&!a.isMobile&&(i.lyric?a.createLyric(i.lyric):a.noLyric()),!a.first||s?a.sound.play():a.first=!1}),this;this.nextSound()},createLyric:function(t){this.emptyLyric();for(var i=0,s=[],e=(p=t.split("\n")).length,a=this.DOM,n=/\[(\d+:\d+.?\d+)\]/g,r=/[^\[(\d+):(\d+.?\d+)\]\s*].+/g,o="";i<e;i++){var l=f.trim(p[i]).match(n);if(f.isArray(l))for(var h=f.trim(p[i]).match(r),d=0;d<l.length;d++){var u=l[d].replace("[","").replace("]","").split(":"),u=60*u[0]+Math.floor(u[1]);s.push({time:u,lyric:f.isArray(h)?h[0]:"&nbsp;"})}}if(!s.length)return this.noLyric(),!1;for(i=0,e=s.length;i<e;i++)for(var c,d=i;d<e;d++)s[i].time>s[d].time&&(c=s[i],s[i]=s[d],s[d]=c);for(this.lyric={},i=0;i<e;i++)o+="<li>"+s[i].lyric+"</li>",this.lyric[s[i].time]=i;a.lyricList=f(o).appendTo(a.lyrics.children("ul"));var p=a.lyrics.children("ul").height(),t=Math.floor(this.lyricH/2),a=p-t;this.offset={min:Math.floor(t/this.line),max:Math.floor(a/this.line)}},setLyric:function(t){var i=this.DOM,s=this.offset,e=Math.floor(t/1e3),t=this.lyric&&this.lyric[e],e=0;void 0!==t&&i.lyricList&&this.mark!=t&&(t>=s.min&&(e=t-s.min),t>=s.max&&(e=s.max-s.min),i.lyricList.removeClass("current").eq(t).addClass("current"),i.lyrics.children("ul").css("margin-top",-e*this.line),this.mark=t)},emptyLyric:function(){var t=this.DOM;this.lyric=null,t.lyrics.children("ul").css("margin-top",0).html("")},noLyric:function(t){var i=this.DOM,t=void 0===t?"暂无歌词":t;this.lyric=null,i.lyrics.children("ul").html("<li>"+t+"</li>")},addEvent:function(){var e,a,i=this.DOM,s=this,t=this.isMobile?"touchend":"click";i.listbtn.on(t,function(){var t=f(this).hasClass("wp-player-open");i.lyrics.children("ul").stop(!0,!0).hide(),f(this)[t?"removeClass":"addClass"]("wp-player-open"),i.list.show()[t?"removeClass":"addClass"]("wp-player-list-hide")}),this.attr.lyric&&i.lyricsbtn.on(t,function(){i.listbtn.addClass("wp-player-open"),i.list.hide(),i.lyrics.children("ul").stop(!0,!0).fadeIn()});function n(t){var i=void 0===t?f(this):f(t).parents("li"),t=parseInt(i.attr("data-index"),10),i=i.hasClass("current")&&0<s.sound.playState;t<0||t>s.data.length-1?s.index=0:s.index=t,i&&!s.sound.paused?s.sound.pause():i&&s.sound.paused?s.sound.resume():(s.sound&&s.sound.pause(),s.reset().setList(),s.data[s.index]&&s.data[s.index].url?s.createSound(s.index):s.getSongInfo(s.index,!0))}return this.isMobile?(i.list[0].addEventListener("touchstart",function(t){var i=t.target.nodeName;"A"!==i&&"SPAN"!==i||(t=t.touches[0],e=t.clientX,a=t.clientY)},!1),i.list[0].addEventListener("touchend",function(t){var i,s=t.target.nodeName;"A"!==s&&"SPAN"!==s||(s=(i=t.changedTouches[0]).clientX,i=i.clientY,Math.abs(e-s)<6&&Math.abs(a-i)<6&&(n(t.target),a=e=null))},!1)):i.list.on("click","li",function(){n.call(this)}),this},soundEvent:function(){var t=this.DOM,i=this,s=this.isMobile?"touchend":"click";return this.isMobile||t.seekbar.off().on(s,function(t){i.seekbar(t)}),t.play.off().on(s,function(){i.play()}),t.stop.off().on(s,function(){i.stop()}),1<this.data.length&&(t.previous.off().on(s,function(){i.prevSound()}),t.next.off().on(s,function(){i.nextSound()})),this},seekbar:function(t){var i=this.DOM,t=(t.offsetX||(t.clientX-i.progress.offset().left).toFixed(0))/i.progress.width()*this.sound.duration;(t=t<0?0:t)>this.sound.duration&&(t=this.sound.duration),this.sound.setPosition(t),i.lyricList&&i.lyricList.removeClass("current")},play:function(){this.sound[this.sound.playState<1?"play":"resume"]()},stop:function(){this.sound.pause()},prevSound:function(){1==this.attr.random?this.index=this.random():--this.index<0&&(this.index=this.data.length-1),this.sound&&this.sound.pause(),this.reset().setList(),this.data[this.index]&&this.data[this.index].url?this.createSound(this.index):this.getSongInfo(this.index,!0)},nextSound:function(){var t=this.data.length-1;1==this.attr.random?this.index=this.random():++this.index>t&&(this.index=0),this.sound&&this.sound.pause(),this.reset().setList(),this.data[this.index]&&this.data[this.index].url?this.createSound(this.index):this.getSongInfo(this.index,!0)},setPlay:function(){var t=this.DOM;return t.playing.stop(!0,!0)[this.IE6||this.isMobile?"show":"fadeIn"](),t.play.hide(),t.stop.show(),this},setStop:function(){var t=this.DOM;return t.playing.stop(!0,!0)[this.IE6||this.isMobile?"hide":"fadeOut"](),t.play.show(),t.stop.hide(),this},random:function(){return this.data&&1!==this.data.length&&Math.floor(Math.random()*this.data.length)||0},reset:function(){var t=this.DOM;return this.setStop(),t.seekbar.width(0),t.playbar.width(0),this},setList:function(){var t=this.DOM,i=this.index,s=t.list.find("li").eq(0).outerHeight(),e=Math.floor(t.list.height()/s),a=Math.floor(e/2),n=a,r=this.data.length-a;return this.data.length>e&&(i<=n&&t.list.scrollTop(0),n<i&&i<r&&t.list.scrollTop((i-a)*s),r<=i&&t.list.scrollTop(t.list.children("ul").outerHeight())),t.list.find("li").removeClass("current").eq(this.index).addClass("current"),this},getDOM:function(t){var i=t[0].getElementsByTagName("*"),s={};s.wrap=t;for(var e=0;e<i.length;e++)-1<i[e].className.indexOf("wp-player")&&(s[i[e].className.replace("wp-player","").replace(/-/g,"")]=f(i[e]));return this.DOM=s,this},formatNumber:function(t){return t.toString().length<2?"0"+t:t},getAttr:function(){var t=this.DOM,i=t.wrap.attr("data-lyric"),i=void 0!==i&&"open"==i;return this.attr={source:t.wrap.attr("data-source"),type:t.wrap.attr("data-type"),id:t.wrap.attr("data-id"),title:t.wrap.attr("data-title"),author:t.wrap.attr("data-author"),address:t.wrap.attr("data-address"),thumb:t.wrap.attr("data-thumb"),autoplay:t.wrap.attr("data-autoplay"),random:t.wrap.attr("data-random"),lyric:i},this},destroy:function(){this.sound&&this.sound.unload(),this.sound="",this.attr.lyric&&(this.DOM.lyrics.children("ul").html(""),this.DOM.listbtn.trigger(this.isMobile?"touchend":"click").removeClass("wp-player-open")),this.reset(),this.DOM.list.removeClass("wp-player-list-hide").children("ul").html(""),this.DOM.thumb.children("img").attr("src",this.img),this.DOM.time.text("00:00"),this.DOM.title.text("Loading..."),this.DOM.author.text("Loading..."),this.DOM.wrap.data("WPPlayer",""),this.DOM.wrap.off().find("*").off(),this.index=0,this.lyric=null,this.offset={},this.mark=null,this.lyricH=300,this.line=27,this.isLoad=!1,this.first=!0,this.attr={},this.data=[],this.img=null,this.DOM={}},reload:function(){this.destroy(),this.getDOM(this.$elem).getAttr().init(),this.DOM.wrap.data("WPPlayer",this)}},r.template='<li data-index="{i}" class="{class}"><a href="javascript:void(0);"><span class="wp-player-list-author">{author}</span><span class="wp-player-list-order">{serial}</span><span class="wp-player-list-title">{title}</span></a></li>',f.fn.WPPlayer=function(i){return this.each(function(){var t=f(this);"string"==typeof i?t.data("WPPlayer")&&t.data("WPPlayer")[i]():t.data("WPPlayer",new r(this,i))})}}(jQuery,soundManager),jQuery('[data-wp-player="wp-player"]').WPPlayer(wp_player_params);